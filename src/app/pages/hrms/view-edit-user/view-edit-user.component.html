<!-- Top filter bar (optional) -->
<div class="p-fluid grid align-items-end gap-3 mb-3">
  <div class="col-12 md:col-3">
    <label class="mb-1 block">Filter Field</label>
    <p-dropdown [options]="filterOptions" [(ngModel)]="selectedField" optionLabel="label" optionValue="value"></p-dropdown>
  </div>
  <div class="col-12 md:col-4">
    <label class="mb-1 block">Search</label>
    <input pInputText [(ngModel)]="searchText" placeholder="Type to search..." />
  </div>
  <div class="col-12 md:col-2">
    <button pButton label="Search" icon="pi pi-search" (click)="onSearch()"></button>
  </div>
</div>

<!-- Users Table -->
<p-table
  [value]="userList"
  [paginator]="true"
  [rows]="limit"
  [totalRecords]="total"
  [lazy]="true"
  [loading]="loading"
  (onLazyLoad)="loadUsers($event)"
  responsiveLayout="scroll"
>
  <ng-template pTemplate="header">
    <tr>
      <th>User Name</th>
      <th>Mobile No</th>
      <th>Email</th>
      <th>Role</th>
      <th style="width: 8rem">Actions</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-user>
    <tr>
      <td>{{ user.user_name }}</td>
      <td>{{ user.mobile_no }}</td>
      <td>{{ user.email }}</td>
      <td>{{ user.role }}</td>
      <td>
        <button
          pButton
          type="button"
          icon="pi pi-pencil"
          label="Edit"
          class="p-button-sm p-button-outlined"
          (click)="openEditDialog(user)"
        ></button>
      </td>
    </tr>
  </ng-template>
</p-table>

<!-- Edit User Dialog with Stepper -->
<p-dialog header="Edit User" [(visible)]="showDialog" [modal]="true" [style]="{ width: '92vw' }">
  <p-stepper [value]="activeStep" class="w-full">
    <p-step-list>
      <p-step [value]="1">Personal Information</p-step>
      <p-step [value]="2">Documents</p-step>
      <p-step [value]="3">Office Information</p-step>
    </p-step-list>

    <p-step-panels>
      <!-- STEP 1: Personal -->
      <p-step-panel [value]="1">
        <ng-template #content let-activateCallback="activateCallback">
          <form [formGroup]="editForm" class="p-fluid grid gap-3">
            <div class="field col-12 md:col-4">
              <label>User Name</label>
              <input pInputText formControlName="user_name" />
            </div>
            <div class="field col-12 md:col-4">
              <label>Mobile No</label>
              <input pInputText formControlName="mobile_no" />
            </div>
            <div class="field col-12 md:col-4">
              <label>Email</label>
              <input pInputText formControlName="email" />
            </div>
            <div class="field col-12 md:col-4">
              <label>Password</label>
              <input type="password" pInputText formControlName="password" />
            </div>
          </form>
          <div class="flex justify-end mt-3">
            <p-button label="Next" icon="pi pi-arrow-right" (onClick)="activateCallback(2)" />
          </div>
        </ng-template>
      </p-step-panel>

      <!-- STEP 2: Documents (Default + Prev + PG + UG) -->
      <p-step-panel [value]="2">
        <ng-template #content let-activateCallback="activateCallback">
          <!-- Default Docs -->
          <h5 class="mt-0 mb-2 font-semibold text-lg">Upload Documents</h5>
          <div class="grid">
            <div class="col-12 md:col-4" *ngFor="let doc of documents">
              <div class="flex flex-column gap-2 p-3 border-1 border-round surface-card shadow-1">
                <label class="font-medium">{{ doc.label }}</label>
                <p-fileUpload
                  mode="basic"
                  name="{{doc.name}}"
                  [accept]="doc.accept"
                  [chooseLabel]="doc.label"
                  (onSelect)="pickFile(doc.name, $event)">
                </p-fileUpload>
              </div>
            </div>
          </div>

          <!-- Previous Employment -->
          <h5 class="mt-4 mb-2 font-semibold text-lg">Previous Employment</h5>
          <div *ngFor="let c of prevCompanies; let i = index" class="border-1 border-round surface-card p-3 mb-3 shadow-1">
            <div class="p-fluid grid gap-3">
              <div class="col-12 md:col-4">
                <label>Company Name</label>
                <input type="text" pInputText [(ngModel)]="c.companyName" name="companyName{{i}}" />
              </div>
              <div class="col-12 md:col-4">
                <label>Relieving Letter</label>
                <p-fileUpload mode="basic" (onSelect)="c.relieving = $event.files[0]" chooseLabel="Upload"></p-fileUpload>
              </div>
              <div class="col-12 md:col-4">
                <label>Experience Letter</label>
                <p-fileUpload mode="basic" (onSelect)="c.experience = $event.files[0]" chooseLabel="Upload"></p-fileUpload>
              </div>
              <div class="col-12 md:col-4">
                <label>Payslips</label>
                <p-fileUpload mode="basic" multiple (onSelect)="c.payslips = $event.files" chooseLabel="Upload"></p-fileUpload>
              </div>
              <div class="col-12">
                <button pButton type="button" icon="pi pi-trash" class="p-button-text text-red-500" *ngIf="i > 0" (click)="removeCompany(i)">Remove</button>
              </div>
            </div>
          </div>
          <button pButton type="button" label="Add Company" icon="pi pi-plus" (click)="addCompany()"></button>

          <!-- PG Certificates -->
          <h5 class="mt-4 mb-2 font-semibold text-lg">Postgraduate Certificates</h5>
          <div *ngFor="let pg of pgCertificates; let i = index" class="border-1 border-round surface-card p-3 mb-3 shadow-1">
            <div class="p-fluid grid gap-3">
              <div class="col-12 md:col-6">
                <label>PG Certificate</label>
                <p-fileUpload mode="basic" (onSelect)="pg.certificate = $event.files[0]" chooseLabel="Upload"></p-fileUpload>
              </div>
              <div class="col-12 md:col-6">
                <label>PG Marksheet</label>
                <p-fileUpload mode="basic" (onSelect)="pg.marksheet = $event.files[0]" chooseLabel="Upload"></p-fileUpload>
              </div>
              <div class="col-12">
                <button pButton type="button" icon="pi pi-trash" class="p-button-text text-red-500" *ngIf="i > 0" (click)="removePgCertificate(i)">Remove</button>
              </div>
            </div>
          </div>
          <button pButton type="button" label="Add PG" icon="pi pi-plus" (click)="addPgCertificate()"></button>

          <!-- UG Certificates -->
          <h5 class="mt-4 mb-2 font-semibold text-lg">Undergraduate Certificates</h5>
          <div *ngFor="let ug of ugCertificates; let i = index" class="border-1 border-round surface-card p-3 mb-3 shadow-1">
            <div class="p-fluid grid gap-3">
              <div class="col-12 md:col-6">
                <label>UG Certificate</label>
                <p-fileUpload mode="basic" (onSelect)="ug.certificate = $event.files[0]" chooseLabel="Upload"></p-fileUpload>
              </div>
              <div class="col-12 md:col-6">
                <label>UG Marksheet</label>
                <p-fileUpload mode="basic" (onSelect)="ug.marksheet = $event.files[0]" chooseLabel="Upload"></p-fileUpload>
              </div>
              <div class="col-12">
                <button pButton type="button" icon="pi pi-trash" class="p-button-text text-red-500" *ngIf="i > 0" (click)="removeUgCertificate(i)">Remove</button>
              </div>
            </div>
          </div>
          <button pButton type="button" label="Add UG" icon="pi pi-plus" (click)="addUgCertificate()"></button>

          <div class="flex justify-between mt-3">
            <p-button label="Back" icon="pi pi-arrow-left" (onClick)="activateCallback(1)" />
            <p-button label="Next" icon="pi pi-arrow-right" (onClick)="activateCallback(3)" />
          </div>
        </ng-template>
      </p-step-panel>

      <!-- STEP 3: Office -->
      <p-step-panel [value]="3">
        <ng-template #content let-activateCallback="activateCallback">
          <form [formGroup]="editForm" class="p-fluid grid gap-3">
            <div class="field col-12 md:col-4">
              <label>Position</label>
              <input pInputText formControlName="position" />
            </div>
            <div class="field col-12 md:col-4">
              <label>Role</label>
              <p-dropdown [options]="roles" formControlName="role"></p-dropdown>
            </div>
            <div class="field col-12 md:col-4" *ngIf="editForm.value.role === 'Admin'">
              <label>Designation</label>
              <input pInputText formControlName="designation" />
            </div>
            <div class="field col-12 md:col-4">
              <label>Department</label>
              <input pInputText formControlName="department" />
            </div>
            <div class="field col-12 md:col-4">
              <label>Policy</label>
              <p-dropdown [options]="policies" formControlName="policyName"></p-dropdown>
            </div>
            <div class="field col-12 md:col-4">
              <label>Date of Joining</label>
              <p-calendar formControlName="doj" dateFormat="dd/mm/yy"></p-calendar>
            </div>
          </form>
          <div class="flex justify-between mt-3">
            <p-button label="Back" icon="pi pi-arrow-left" (onClick)="activateCallback(2)" />
            <p-button label="Save" icon="pi pi-check" (onClick)="saveEditedUser()" [disabled]="editForm.invalid" />
          </div>
        </ng-template>
      </p-step-panel>
    </p-step-panels>
  </p-stepper>
</p-dialog>
